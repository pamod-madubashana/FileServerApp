# Universal File Download Utility

This document explains how to use the universal file download utility that works seamlessly in both Tauri desktop apps and web browsers.

## Features

- Works in both Tauri 2 desktop applications and modern web browsers
- Handles large files efficiently using proper ArrayBuffer handling
- Supports all file types (images, videos, archives, documents, etc.)
- Provides native save dialogs in both environments
- Includes comprehensive error handling
- Fully reusable TypeScript function

## Installation

The required dependencies are already included in your project:

```bash
npm install @tauri-apps/plugin-dialog @tauri-apps/plugin-fs @tauri-apps/plugin-http
```

## Setup

### 1. Tauri Capabilities

Ensure the following permissions are added to your `src-tauri/capabilities/default.json`:

```json
{
  "permissions": [
    "dialog:allow-save",
    "fs:allow-write-file",
    "fs:allow-read-file",
    "http:allow-fetch",
    "http:allow-fetch-send",
    "http:allow-fetch-read-body"
  ]
}
```

### 2. Import the Function

Import the download function in your components:

```typescript
import { downloadFile } from '@/lib/download-utils';
```

## Usage

### Basic Usage

```typescript
import { downloadFile } from '@/lib/download-utils';

// Download a file from a relative path
await downloadFile('/dl/document.pdf', 'document.pdf');

// Download a file from a full URL
await downloadFile('https://example.com/files/image.jpg', 'image.jpg');
```

### In a React Component

```typescript
import React, { useState } from 'react';
import { Button } from '@/components/ui/button';
import { downloadFile } from '@/lib/download-utils';

const FileDownloadButton: React.FC<{ 
  filePath: string; 
  fileName: string 
}> = ({ filePath, fileName }) => {
  const [isDownloading, setIsDownloading] = useState(false);

  const handleDownload = async () => {
    setIsDownloading(true);
    try {
      await downloadFile(filePath, fileName);
      // Success notification
    } catch (error) {
      // Error handling
      console.error('Download failed:', error);
    } finally {
      setIsDownloading(false);
    }
  };

  return (
    <Button onClick={handleDownload} disabled={isDownloading}>
      {isDownloading ? 'Downloading...' : 'Download'}
    </Button>
  );
};
```

## How It Works

### Tauri Environment Detection

The utility automatically detects whether it's running in a Tauri environment:

```typescript
const isTauri = () => {
  return typeof window !== 'undefined' && (window as any).__TAURI_INTERNALS__ !== undefined;
};
```

### Tauri Implementation

1. Shows a native save dialog using `@tauri-apps/plugin-dialog`
2. Fetches the file using `@tauri-apps/plugin-http` for better performance
3. Writes the file to disk using `@tauri-apps/plugin-fs`

### Browser Implementation

1. Uses the standard browser download mechanism
2. Fetches the file using the browser's native `fetch` API
3. Creates a Blob and uses `URL.createObjectURL` for download

## Error Handling

The function provides comprehensive error handling:

```typescript
try {
  await downloadFile('/dl/file.zip', 'file.zip');
} catch (error) {
  if (error instanceof Error) {
    console.error('Download failed:', error.message);
  }
}
```

Common errors include:
- Network errors
- Permission denied
- File not found
- User cancelled save dialog
- Disk write errors

## Integration Example

Here's how the download function was integrated into the FileExplorer component:

```typescript
const handleDownload = async (item: FileItem) => {
  try {
    const fileName = item.name;
    const downloadPath = `/dl/${fileName}`;
    
    // Use our universal download function
    await downloadFile(downloadPath, fileName);
    
    toast.success(`Downloaded "${fileName}" successfully`);
  } catch (error) {
    logger.error("Failed to download file:", error);
    toast.error(`Failed to download "${fileName}": ${error instanceof Error ? error.message : 'Unknown error'}`);
  }
};
```

## Best Practices

1. **Always handle errors**: Wrap download calls in try/catch blocks
2. **Provide user feedback**: Show loading states and success/error notifications
3. **Use descriptive filenames**: Ensure filenames accurately represent the content
4. **Test in both environments**: Verify functionality in both Tauri and browser

## Troubleshooting

### Tauri Permissions

If downloads fail in Tauri, check that all required permissions are enabled in `capabilities/default.json`.

### CORS Issues

For browser environments, ensure your backend server includes proper CORS headers:

```http
Access-Control-Allow-Origin: *
Access-Control-Allow-Headers: Content-Type, Authorization
```

### Large File Handling

The utility uses ArrayBuffer for efficient handling of large files, but extremely large files may still cause memory issues. For very large files, consider implementing streaming downloads.

## Enhanced Download System

The application now includes an enhanced download system with additional features:

1. **Download Queue Management**: The `DownloadManager` class handles multiple concurrent downloads
2. **Progress Tracking**: Real-time progress updates for downloads
3. **Automatic Retry**: Built-in retry logic with exponential backoff
4. **Persistent History**: Download history is saved and restored between sessions
5. **Cancellation Support**: Ability to cancel ongoing downloads

For complete documentation of the enhanced download system, see `DOWNLOAD_SYSTEM.md`.

## Customization

You can customize the function behavior by modifying `download-utils.ts`:

1. Adjust the save dialog options
2. Modify error handling behavior
3. Add progress tracking for large downloads
4. Implement retry logic for failed downloads

## API Reference

### `downloadFile(path: string, filename: string): Promise<void>`

Downloads a file from the specified path and saves it with the given filename.

**Parameters:**
- `path`: The URL path to download from (can be relative or absolute)
- `filename`: The name to save the downloaded file as

**Returns:**
- A promise that resolves when the download completes successfully

**Throws:**
- An error if the download fails for any reason